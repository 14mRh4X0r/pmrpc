<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
	<title>Pmrpc Benchmark</title>
	<script type="text/javascript" src="../pmrpc.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>        
</head>
<body>
	<h1>Pmrpc Benchmark</h1>
	<div id="main">
	<iframe id="benchmarkServer" src="benchmarkServer.html"></iframe>
	<iframe id="benchmarkPureServer" src="benchmarkPureServer.html"></iframe>

	<script type="text/javascript" >
    google.load("visualization", "1", {packages:["imageareachart"]});
		var serialCount, count;
		var myTime = new Array();
    var myLocalTime = new Array();
    var myResponseTime = new Array();
		var benchmarkServer = window.frames[0];
		var pureServer = window.frames[1];
		var resultDiv = document.getElementById("result");
		var serverTime;

		function processData(heading){
      var chartData = new google.visualization.DataTable();
      chartData.addColumn('string', 'Delta');
      chartData.addColumn('number', 'Frequency');

      var responseAvg = 0;

			var deltaAvg = 0;
			for (var i = 0; i < count; i++) {
        deltaAvg += myLocalTime[i] - myTime[i];
			}		
			resultDiv.innerHTML +=  heading + " local average time (" + param.length + " Bytes payload) = " + deltaAvg * 1.0 / count + "ms<br/>";

      var delta = new Array();
      var responseDelta = new Array();
			deltaAvg = 0;
			var min = -1;
      var max = -1;

      var response_min = -1;
      var response_max = -1;

			if ( serverTime.length != count ){
				resultDiv.innerHTML += "Warning! Results are flaky! " + (count - serverTime.length) + " results lost<br/>";
      }

      var delta_frequency = {};
      var response_delta_frequency = {};

			for (var i = 0; i < serverTime.length; i++) {
        delta[i] = serverTime[i] - myTime[i];
        responseDelta[i] = myResponseTime[i] - myTime[i];
				if ( min == -1 || delta[i] < min ) min = delta[i];
        if ( max == -1 || delta[i] > max ) max = delta[i];
        if ( delta_frequency[delta[i]] === undefined ) {
          delta_frequency[delta[i]] = 1;
        } else {
          delta_frequency[delta[i]]++;
        }
				deltaAvg += delta[i];							
        responseAvg += myResponseTime[i] - myTime[i];
        if ( response_min == -1 || responseDelta[i] < response_min )
          response_min = responseDelta[i];
        if ( response_max == -1 || responseDelta[i] > response_max )
          response_max = responseDelta[i];
        if ( response_delta_frequency[responseDelta[i]] === undefined ) {
          response_delta_frequency[responseDelta[i]] = 1;
        } else {
          response_delta_frequency[responseDelta[i]]++;
        }
			}
      deltaAvg = 1.0 * deltaAvg / count;
      responseAvg = 1.0 * responseAvg / count;

      var stdDev = 0.0;
      var responseStdDev = 0.0;
			for (var i = 0; i < serverTime.length; i++) {
        stdDev += (delta[i] - deltaAvg) * (delta[i] - deltaAvg);
        responseStdDev += (responseDelta[i] - responseAvg) * (responseDelta[i] - responseAvg);
			}
      stdDev = Math.sqrt(stdDev / count);
      responseStdDev = Math.sqrt(responseStdDev / count);

      var perc95 = stdDev / Math.sqrt(count) * 1.96;
      var response95perc = responseStdDev / Math.sqrt(count) * 1.96;

      resultDiv.innerHTML += heading + " one way trip average time (" + param.length + " Bytes payload) = " + deltaAvg +         
        "ms Min = " + min + "ms Max = " + max + "ms StdDev = " + stdDev  + "ms<br/>";
      resultDiv.innerHTML += heading + " 95% confidence interval [" + (deltaAvg
          - perc95) + "," + (deltaAvg + perc95) + "]<br/>";
      resultDiv.innerHTML += heading  + " pingback inclusive time " + " 95% confidence interval [" + (responseAvg
          - response95perc) + "," + (responseAvg + response95perc) + "]<br/>";

      chartData.addRows(max - min + 1);
      for (var i = min; i <= max; i++) {
        chartData.setValue(i - min, 0, "" + i);
        var value = 0;
        if ( delta_frequency[i] !== undefined ) {
          value = delta_frequency[i];
        }
        chartData.setValue(i - min, 1, value);
      }

      var chart = new google.visualization.ImageAreaChart(document.getElementById(heading + "Graph"));
      chart.draw(chartData, {width: 800, height: 600, min: 0});
		}

		function displayData(heading, resumeFunction){
			pmrpc.call({
				destination : benchmarkServer,
				publicProcedureName : "collectTimingData",
				params : [],
				onSuccess : function(result){
						serverTime = result.returnValue;
						processData(heading);

						pmrpc.call({
							destination : benchmarkServer,
							publicProcedureName : "resetTimingData",
							params : [],
							onSuccess : function(result){
								myTime = [];
                myLocalTime = [];
                myResponseTime = [];
								resumeFunction.call();
							},
							onError : function(statusObj){
								resultDiv.innerHTML += "An error occured!(" + statusObj.description + ")<br/>";
							}
						});
					},
				onError : function(statusObj){
						resultDiv.innerHTML += "An error occured!(" + statusObj.description + ")<br/>";
					}
			});
		}

		function end(){
      resultDiv.innerHTML += "Test finished.<br/>";
		}

		function pureReceiver(e){
	 		if ( e.data[0] == "o" ){
        myResponseTime.push((new Date()).getTime());
        if (e.data[1] == 0){
          resultDiv.innerHTML += "Timing done!<br/>";
					pureServer.postMessage(["t"], "*");	
        } else {
			    myTime.push((new Date()).getTime());
		      pureServer.postMessage(["o", param, e.data[1] - 1], "*");
			    myLocalTime.push((new Date()).getTime());
        }
			}
			else if ( e.data[0] == "t" ){
				serverTime = e.data[1];
				processData("postMessage");
				pureServer.postMessage(["r"], "*");
			}
			else if ( e.data[0] == "r" ){
				myTime = [];
				myLocalTime = [];
			}
      else {
        resultDiv.innerHTML += "Woha....Fail<br/>";
			}
		}

		function pureSerialTest(){
			resultDiv.innerHTML += "Seting up pure postMessage communication<br/>";
      window.addEventListener('message', pureReceiver, false);

			resultDiv.innerHTML += "Running " + count + " x PURE SERIAL ONE-WAY<br/>";
			myTime.push((new Date()).getTime());
		  pureServer.postMessage(["o", param, count - 1], "*");
			myLocalTime.push((new Date()).getTime());
		}

		function serialEnd(){
			displayData("pmrpc", pureSerialTest);
		}

		function serialTest(){
			myTime.push((new Date()).getTime());
			pmrpc.call({
				destination : benchmarkServer,
				publicProcedureName : "oneWay",
				params : [param, -1],
        onSuccess : function(result){
            myResponseTime.push((new Date()).getTime());
						if (serialCount > 1){
							serialCount--;
							serialTest();
						}
						else {
						 	serialEnd();
						}
					},
				onError : function(statusObj){
					resultDiv.innerHTML += "An error occured!(" + statusObj.description + ")<br/>";
					}
			});
			myLocalTime.push((new Date()).getTime());
		}

		function runSerialTests(serialParam, cnt){
			serialCount = cnt;
			count = cnt;
			param = serialParam;
			serialTest();
		}

		function test(cnt, size){
      resultDiv = document.getElementById("result");
      var param = "";
			for (var i = 0; i < size; i++)
				param += Math.floor(Math.random()*10);
			resultDiv.innerHTML = "Running " + cnt + " x PMRPC SERIAL ONE-WAY<br/>";
			runSerialTests(param, cnt);
		}
  </script>
  <br/>
	<input type="button" onClick="test(1000, 1024);" value="1000 x 1024" />
	<input type="button" onClick="test(3000, 1024);" value="3000 x 1024" />
  <input type="button" onClick="test(5000, 1024);" value="5000 x 1024" />
	<input type="button" onClick="test(7000, 1024);" value="7000 x 1024" />
	<input type="button" onClick="test(9000, 1024);" value="9000 x 1024" />
	<input type="button" onClick="test(10000, 1024);" value="10000 x 1024" />
	<input type="button" onClick="test(50000, 1024);" value="50000 x 1024" />
  <br/>
  <input type="button" onClick="test(2000, 1);" value="2000 x 1" />
  <input type="button" onClick="test(2000, 10);" value="2000 x 10" />
  <input type="button" onClick="test(2000, 100);" value="2000 x 100" />
  <input type="button" onClick="test(2000, 1024);" value="2000 x 1KB" />
  <input type="button" onClick="test(2000, 10240);" value="2000 x 10KB" />
  <input type="button" onClick="test(2000, 102400);" value="2000 x 100KB" />
  <input type="button" onClick="test(2000, 5*102400);" value="2000 x 500KB" />
  <input type="button" onClick="test(2000, 1024*1024);" value="2000 x 1MB" />
	</div>
	<div id="result">
  </div>
  <div id="pmrpcGraph">
  </div>
  <div id="postMessageGraph">
  </div>
</body>
</html>
