<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <title>Pmrpc Test Suite</title>
  <!-- QUnit -->
  <script type="text/javascript" src="http://github.com/jquery/qunit/raw/master/qunit/qunit.js"></script>
  <link rel="stylesheet" href="http://github.com/jquery/qunit/raw/master/qunit/qunit.css" type="text/css" media="screen" />

  <script type="text/javascript" src="../pmrpc.js"></script>
  <script type="text/javascript">
    function logger(text) {
      if (typeof console !== "undefined" && typeof console.log !== "undefined") {
        console.log(text);
      }
    }
    
    pmrpc.register({
      publicProcedureName : "logger",
      procedure : logger
    });
  </script>
</head>
<body>
  <h1 id="qunit-header">Pmrpc Test Suite</h1>
  <h2 id="qunit-banner"></h2>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="main"></div>
  
  <iframe id="testingCrossDocumentServer1" name="testingCrossDocumentServer2" src="testingCrossDocumentServer.html" width="0" height="0" frameborder=0></iframe>
  
  <iframe id="multipleTest1" name="multipleTest1" src='http://1111.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerMultipleEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="multipleTest2" name="multipleTest2" src='http://2222.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerMultipleEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="multipleTest3" name="multipleTest3" src='http://3333.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerMultipleEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="publishTest1" name="publishTest1" src='http://4444.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerPublishEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="publishTest2" name="publishTest2" src='http://5555.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerPublishEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="publishTest3" name="publishTest3" src='http://6666.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerPublishEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="domainTest1" name="domainTest1" src='http://7777.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerDomainEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%2B%5C%221%5C%22%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="domainTest2" name="domainTest2" src='http://8888.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerDomainEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%2B%5C%222%5C%22%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  <iframe id="domainTest3" name="domainTest3" src='http://9999.urlecho.appspot.com/echo?jsonResponse=%7B%22status%22%3A200%2C%22headers%22%3A%7B%22Content-Type%22%3A%22text%2Fhtml%22%7D%2C%22content%22%3A%22%3Chtml%20lang%3D%5C%22en%5C%22%3E%5Cn%3Chead%3E%5Cn%20%20%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%20src%3D%5C%22http%3A%2F%2Fpmrpc.googlecode.com%2Fsvn%2Ftrunk%2Fpmrpc.js%5C%22%3E%3C%2Fscript%3E%5Cn%3C%2Fhead%3E%5Cn%3Cbody%3E%5Cn%3Cscript%20type%3D%5C%22text%2Fjavascript%5C%22%3E%5Cn%20%20pmrpc.register(%20%7B%5Cn%20%20%20%20publicProcedureName%20%3A%20%5C%22testingServerDomainEchoMethod%5C%22%2C%20%5Cn%20%20%20%20procedure%20%3A%20function(echo)%20%7Breturn%20echo%2B%5C%223%5C%22%3B%7D%20%7D)%3B%5Cn%3C%2Fscript%3E%5Cn%3C%2Fbody%3E%5Cn%3C%2Fhtml%3E%22%7D' width="0" height="0" frameborder=0></iframe>
  
  
  <script type="text/javascript">
    var testingCrossDocumentServer = window.frames[0];

    module("Inter-window communication");
    
    test("Cross-document messaging API implemented", 1, function() {
      var crossDocImplemented = typeof postMessage !== "undefined";
      ok(crossDocImplemented, "Cross-document messaging API must be implemented.");
    });
    
    asyncTest("Normal echo call", 1, function() {
      var testingServerEchoMethod = "testingServerEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          equals(result.returnValue, testingEchoParameter);
          start(); },
        onError : function(statusObj){
          ok(false, statusObj.description);
          start();}});    
    });
    
    asyncTest("Retries", 1, function() {
      var testingServerEchoMethodRetries = "testingServerEchoMethodRetries";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethodRetries, 
        params : [testingEchoParameter],
        retries : 10,
        onSuccess : function(result) {
          equals(result.returnValue, testingEchoParameter);
          start(); },
        onError : function(statusObj) {
          ok(false, statusObj.description);
          start();}});    
    });
    
    asyncTest("0 retries call", 1, function() {
      var testingServerEchoMethod = "testingServerEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        retries : 0,
        publicProcedureName : testingServerEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          equals(result.returnValue, testingEchoParameter);
          start(); },
        onError : function(statusObj){
          ok(false, statusObj.description);
          start();}});    
    });
    
    asyncTest("Unregistered procedure call", 1, function() {
      var testingServerUnregisteredMethod = "testingServerUnregisteredMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerUnregisteredMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          ok(false);
          start(); },
        onError : function(statusObj){
          ok(true);
          start();}});    
    });
    
    asyncTest("Non-pmrpc call", 1, function() {
      var testingServerUnregisteredMethod = "testingServerUnregisteredMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      
      function nonPmrpcTest(evt) {
        equals(evt.data, testingEchoParameter);
        if (window.removeEventListener) {
          window.removeEventListener("message", nonPmrpcTest, false);
        } else {
          window.detachEvent("onmessage", nonPmrpcTest);
        }
        start();
      }
      
      if (window.addEventListener) {
        window.addEventListener("message", nonPmrpcTest, false);
      } else {
        window.attachEvent("onmessage", nonPmrpcTest);
      }
      window.postMessage(testingEchoParameter, "*");
    });

    asyncTest("Destination domain supported", 1, function() {
      var testingServerEchoMethod = "testingServerEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethod, 
        params : [testingEchoParameter],
        destinationDomain : "*",
        onSuccess : function(result){
          equals(result.returnValue, testingEchoParameter);
          start(); },
        onError : function(statusObj){
          ok(false, statusObj.description);
          start();}});    
    });    

    asyncTest("Destination domain unsupported through whitelist", 1, function() {
      var testingServerEchoMethod = "testingServerEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethod, 
        params : [testingEchoParameter],
        destinationDomain : "http://www.fail.com",
        onSuccess : function(result){
          ok(false, "help!");
          start(); },
        onError : function(statusObj){
          ok(true);
          start();}});    
    });
    
    asyncTest("Source domain unsupported through blacklist", 1, function() {
      var testingServerEchoMethodUnsupportedBL = "testingServerEchoMethodUnsupportedBL";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethodUnsupportedBL, 
        params : [testingEchoParameter],
        onSuccess : function(result) {
          ok(false);
          start(); },
        onError : function(statusObj) {
          ok(true);
          start();}});    
    });      
    
    asyncTest("Source domain unsupported through whitelist", 1, function() {
      var testingServerEchoMethodUnsupportedWL = "testingServerEchoMethodUnsupportedWL";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethodUnsupportedWL, 
        params : [testingEchoParameter],
        onSuccess : function(result) {
          ok(false);
          start(); },
        onError : function(statusObj) {
          ok(true);
          start();}});    
    });
    
    asyncTest("Asynchronous method", 1, function() {
      var testingServerEchoMethodAsynchronous = "testingServerEchoMethodAsynchronous";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethodAsynchronous, 
        params : [testingEchoParameter],
        onSuccess : function(result) {
          equals(result.returnValue, testingEchoParameter);
          start(); },
        onError : function(statusObj) {
          ok(false, statusObj.description);
          start();}});    
    });
    
    asyncTest("Named parameters", 1, function() {
      var testingServerEchoMethod = "testingServerEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethod, 
        params : { echo : testingEchoParameter },
        onSuccess : function(result) {
          equals(result.returnValue, testingEchoParameter);
          start(); },
        onError : function(statusObj) {
          ok(false, statusObj.description);
          start();}});    
    });
    
    asyncTest("Mispelled named parameters", 1, function() {
      var testingServerEchoMethod = "testingServerEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      pmrpc.call({
        destination : testingCrossDocumentServer,
        publicProcedureName : testingServerEchoMethod, 
        params : { ech : testingEchoParameter },
        onSuccess : function(result) {
          ok(false);
          start(); },
        onError : function(statusObj) {
          ok(true);
          start();}});    
    });
    
    // TODO: need test for timeouts
    
    module("Worker communication");
    test("Worker API implemented", 1, function() {
      var dedicatedWorkerImplemented = typeof nonPmrpcWorker !== "undefined";
      ok(dedicatedWorkerImplemented, "Worker API must be implemented.");
    });
    
    asyncTest("Container-to-worker echo", 2, function() {
      var dedicatedWorkerEcho = "dedicatedWorkerEcho";
      var dedicatedTestingWorker = new Worker("testingDedicatedWorker.js");
      
      stop(10000);
      
      pmrpc.call({
        destination : dedicatedTestingWorker,
        publicProcedureName : "pmrpcWorkerTester",
        params : [dedicatedWorkerEcho],
        onSuccess : function (result) {
          equals(result.returnValue, dedicatedWorkerEcho);
        },
        onError : function (result) {
          ok(false, result.description);
        }
      });
        
      function containerWorkerTest(testerParam) {
        var dedicatedWorkerEcho = "dedicatedWorkerEcho";
        equals(testerParam, dedicatedWorkerEcho);
        start();
        return testerParam;
      }
      pmrpc.register({
        publicProcedureName : "containerWorkerTest",
        procedure : containerWorkerTest
      });
    });
    
    test("SharedWorker API implemented", 1, function() {
      var sharedWorkerImplemented = typeof nonPmrpcSharedWorker !== "undefined";
      ok(sharedWorkerImplemented, "SharedWorker API must be implemented.");
    });
    
    asyncTest("Container-to-sharedWorker echo", 2, function() {
      var sharedWorkerEcho = "sharedWorkerEcho";
      var sharedTestingWorker = new SharedWorker("testingSharedWorker.js", "worker123");
      
      stop(10000);
      
      pmrpc.call({
        destination : sharedTestingWorker,
        publicProcedureName : "pmrpcSharedWorkerTester",
        params : [sharedWorkerEcho],
        onSuccess : function (result) {
          equals(result.returnValue, sharedWorkerEcho);
        },
        onError : function (result) {
          ok(false, result.description);
        }
      });
        
      function containerSharedWorkerTest(testerParam) {
        var sharedWorkerEcho = "sharedWorkerEcho";
        equals(testerParam, sharedWorkerEcho);
        start();
        return testerParam;
      }
      pmrpc.register({
        publicProcedureName : "containerSharedWorkerTest",
        procedure : containerSharedWorkerTest
      });
    });
    
    test("Nested workers implemented", 1, function() {
      var nestedParentTestingWorker = new Worker("nestedParentTestingWorker.js");
      
      stop(10000);
      
      function nestedWorkersImplemented(testerParam) {
        ok(testerParam, testerParam.toString());
        pmrpc.unregister("nestedWorkersImplemented");
        start();
      }
      
      pmrpc.register({
        publicProcedureName : "nestedWorkersImplemented",
        procedure : nestedWorkersImplemented
      });
    });
    
    asyncTest("Nested workers echo", 1, function() {
      var nestedWorkerEcho = "nestedWorkerEcho";
      var nestedParentTestingWorker = new Worker("nestedParentTestingWorker.js");
      
      stop(10000);
      
      function containerNestedWorkerTest(testerParam) {
        equals(testerParam, nestedWorkerEcho);
        pmrpc.unregister("containerNestedWorkerTest");
        start();
      }
      
      pmrpc.register({
        publicProcedureName : "containerNestedWorkerTest",
        procedure : containerNestedWorkerTest
      });
    });
    
    module("Pubsub");
    
    test("Multiple destination windows", 3, function() {
      var testingServerMultipleEchoMethod = "testingServerMultipleEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      var count = 0;
      
      stop(10000);
      
      pmrpc.call({
        destination : [window.frames["multipleTest1"], window.frames["multipleTest2"], window.frames["multipleTest3"]],
        publicProcedureName : testingServerMultipleEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          equals(result.returnValue, testingEchoParameter);
          count++;
          if (count === 3) {
            start();
          }
        },
        onError : function(statusObj){
          ok(false, statusObj.description);
          count++;
          if (count === 3) {
            start();
          }
        }
      });
    });
    
    test("Publish to everyone", 1, function() {
      var testingServerPublishEchoMethod = "testingServerPublishEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      var succCount = 0;
      var errCount = 0;
      
      stop(10000);
      pmrpc.call({
        destination : "publish",
        publicProcedureName : testingServerPublishEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          if (result.returnValue === testingEchoParameter) {
            succCount++;
          } else {
            errCount++;
          }
          if (succCount === 3) {
            ok(true, "Publish works!");
            start();
          }
        },
        onError : function(statusObj){
          errCount++;
        }
      });   
    });
    
    test("Send single message with multiple domains", 1, function() {
      var testingServerEchoMethod = "testingServerDomainEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
            
      stop(10000);
      
      pmrpc.call({
        destination : [window.frames["domainTest1"]],
        destinationDomain : ["http://7777.urlecho.appspot.com", "http://8888.urlecho.appspot.com", "http://9999.urlecho.appspot.com"],
        publicProcedureName : testingServerEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          equals(testingEchoParameter+"1", result.returnValue, "OK");
          start();
        },
        onError : function(statusObj){
          ok(false, statuObj.description);
          start();
        }
      });
    });
    
    test("Send message to multiple windows with multiple domains", 1, function() {
      var testingServerEchoMethod = "testingServerDomainEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      stop(10000);
      
      var succCount = 0;
      var errCount = 0;
      
      pmrpc.call({
        destination : [window.frames["domainTest1"], window.frames["domainTest2"], window.frames["domainTest3"]],
        destinationDomain : ["http://7777.urlecho.appspot.com", "http://9999.urlecho.appspot.com"],
        publicProcedureName : testingServerEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          if (result.returnValue === testingEchoParameter+"1" || result.returnValue === testingEchoParameter+"3") {
            succCount++;
            if (succCount + errCount === 3) {
              if (succCount === 2 && errCount === 1) {
                ok(true, "OK");
                start();
              } else {
                ok(false, "NOT OK");
              }
            }
          } else {
            ok(false, "NOT OK");
          }
        },
        onError : function(statusObj){
          errCount++;
          if (succCount + errCount === 3) {
            if (succCount === 2 && errCount === 1) {
              ok(true, "OK");
              start();
            } else {
              ok(false, "NOT OK");
            }
          }
        }
      });
    });
    
    test("Pubsub with multiple domains", 1, function() {
      var testingServerPublishEchoMethod = "testingServerDomainEchoMethod";
      var testingEchoParameter = "testingEchoParameter";
      
      var succCount = 0;
      var errCount = 0;
      
      stop(10000);
      pmrpc.call({
        destination : "publish",
        destinationDomain : ["http://7777.urlecho.appspot.com"],
        publicProcedureName : testingServerPublishEchoMethod, 
        params : [testingEchoParameter],
        onSuccess : function(result){
          if (result.returnValue === testingEchoParameter+"1") {
            succCount++;
          } else {
            ok(false, result.returnValue);
            start();
          }
          if (errCount + succCount === 5) {
            ok(succCount === 1 && errCount === 4, "OK");
            start();
          }
        },
        onError : function(statusObj){
          errCount++;
          if (errCount + succCount === 5) {
            ok(succCount === 1 && errCount === 4, "OK");
            start();
          }
        }
      });   
    });
    
    // pubsub to workers and from workers
    
    module("Discovery");
    
    test("Pull-based discovery - window contraints.", 1, function() {
      
      stop(10000);
      //all
      pmrpc.discover({
        destination : [window.frames["multipleTest1"], window.frames["multipleTest2"], window.frames["multipleTest3"]],
        callback : function(discoveredMethods) {
          equals(discoveredMethods.length, 3);
          start();
        }
      });
    });
    
    test("Pull-based discovery - origin contraints.", 1, function() {
      stop(10000);
      //origin
      pmrpc.discover({
        destination : [window.frames["multipleTest1"], window.frames["multipleTest2"], window.frames["multipleTest3"]],
        origin : ".*1111.*",
        callback : function(discoveredMethods) {
          equals(discoveredMethods.length, 1);
          start();
        }
      });
    });
    
    test("Pull-based discovery - name contraints.", 1, function() {
      stop(10000);
      //name - pubsub
      pmrpc.discover({
        publicProcedureName : ".*testingServerPublishEchoMethod.*",
        callback : function(discoveredMethods) {
          equals(discoveredMethods.length, 3);
          start();
        }
      });
    });
  </script>
</body>
</html>